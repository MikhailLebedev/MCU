/*byte arr[256] = {0,  0,  0,  0,  0,  1,  1,  1,  1,  1,  2,  2,  2,  2,  2,  3,
   3,  3,  3,  3,  4,  4,  4,  4,  4,  5,  5,  5,  5,  5,  6,  6,
   6,  6,  6,  7,  7,  7,  7,  7,  8,  8,  8,  8,  8,  9,  9,  9,
   9,  10, 10, 10, 10, 10, 11, 11, 11, 11, 12, 12, 12, 12, 13, 13,
   13, 13, 14, 14, 14, 14, 15, 15, 15, 15, 16, 16, 16, 16, 17, 17,
   17, 17, 18, 18, 18, 18, 19, 19, 19, 19, 20, 20, 20, 21, 21, 21,
   21, 22, 22, 22, 23, 23, 23, 24, 24, 24, 24, 25, 25, 25, 26, 26,
   26, 27, 27, 27, 28, 28, 28, 29, 29, 29, 30, 30, 30, 31, 31, 31,
   32, 32, 32, 33, 33, 34, 34, 34, 35, 35, 35, 36, 36, 37, 37, 37,
   38, 38, 39, 39, 40, 40, 40, 41, 41, 42, 42, 43, 43, 44, 44, 44,
   45, 45, 46, 46, 47, 47, 48, 48, 49, 49, 50, 51, 51, 52, 52, 53,
   53, 54, 55, 55, 56, 56, 57, 58, 58, 59, 59, 60, 61, 62, 62, 63,
   64, 64, 65, 66, 67, 67, 68, 69, 70, 71, 71, 72, 73, 74, 75, 76,
  77, 78, 79, 80, 81, 82, 83, 84, 85, 86, 88, 89, 90, 91, 93, 94,
   96, 97, 98, 100,102,103,105,107,109,111,113,115,117,120,122,125,
  127,130,134,137,141,145,149,154,159,165,173,181,191,204,223,255};
*/


byte arr[256] = {  0,  0,  1,  1,  1,  1,  1,  2,  2,  2,  2,  2,  3,
                   3,  3,  3,  3,  4,  4,  4,  4,  4,  5,  5,  5,  5,  5,  6,  6,
                   6,  6,  6,  7,  7,  7,  7,  7,  8,  8,  8,  8,  8,  9,  9,  9,
                   9,  10, 10, 10, 10, 10, 11, 11, 11, 11, 12, 12, 12, 12, 13, 13,
                   13, 13, 14, 14, 14, 14, 15, 15, 15, 15, 16, 16, 16, 16, 17, 17,
                   17, 17, 18, 18, 18, 18, 19, 19, 19, 19, 20, 20, 20, 21, 21, 21,
                   21, 22, 22, 22, 23, 23, 23, 24, 24, 24, 24, 25, 25, 25, 26, 26,
                   26, 27, 27, 27, 28, 28, 28, 29, 29, 29, 30, 30, 30, 31, 31, 31,
                   32, 32, 32, 33, 33, 34, 34, 34, 35, 35, 35, 36, 36, 37, 37, 37,
                   38, 38, 39, 39, 40, 40, 40, 41, 41, 42, 42, 43, 43, 44, 44, 44,
                   45, 45, 46, 46, 47, 47, 48, 48, 49, 49, 50, 51, 51, 52, 52, 53,
                   53, 54, 55, 55, 56, 56, 57, 58, 58, 59, 59, 60, 61, 62, 62, 63,
                   64, 64, 65, 66, 67, 67, 68, 69, 70, 71, 71, 72, 73, 74, 75, 76,
                   77, 78, 79, 80, 81, 82, 83, 84, 85, 86, 88, 89, 90, 91, 93, 94,
                   96, 97, 98, 100, 102, 103, 105, 107, 109, 111, 113, 115, 117, 120, 122, 125,
                   127, 130, 134, 137, 141, 145, 149, 154, 159, 165, 170, 175, 180, 185, 190, 195, 200, 205, 210
                };

byte state[4][4][4];
byte pwm_pins[4] = {3, 5, 6, 9};
byte layer_pins[4] = {10, 11, 12, 13};

void setup() {
  for (byte i = 0; i < 4; ++i) {
    pinMode(pwm_pins[i], OUTPUT);
  }
  for (byte i = 0; i < 4; ++i) {
    pinMode(layer_pins[i], OUTPUT);
  }
}




void loop() {
  byte flag;

  flag = 1;
  while (flag) {
    for (byte i = 0; i < 4; ++i) {
      for (byte j = 0; j < 4; ++j) {
        for (byte k = 0; k < 4; ++k) {
          if (state[i][j][k] == 255) {
            flag = 0;
          } else {
            state[i][j][k] += 1;
          }
        }
      }
    }
    show(1);
  }



  flag = 1;
  while (flag) {
    for (byte i = 0; i < 4; ++i) {
      for (byte j = 0; j < 4; ++j) {
        for (byte k = 0; k < 4; ++k) {
          if (state[i][j][k] == 0) {
            flag = 0;
          } else {
            state[i][j][k] -= 1;
          }
        }
      }
    }
    show(1);
  }

  flag = 1;
  while (flag) {
    for (byte i = 0; i < 4; ++i) {
      for (byte j = 0; j < 4; ++j) {
        for (byte k = 0; k < 4; ++k) {
          if (state[i][j][k] == 255) {
            flag = 0;
          } else {
            state[i][j][k] += 1;
          }
        }
      }
    }
    show(1);
  }



  flag = 1;
  while (flag) {
    for (byte i = 0; i < 4; ++i) {
      for (byte j = 0; j < 4; ++j) {
        for (byte k = 0; k < 4; ++k) {
          if (state[i][j][k] == 0) {
            flag = 0;
          } else {
            state[i][j][k] -= 1;
          }
        }
      }
    }
    show(5);
  }
}

void show(unsigned long tm) {
  unsigned long start_tm = millis();
  byte x = 0;
  byte y = 0;
  byte z = 0;
  while (millis() - start_tm < tm) {
    for (y = 0; y < 4; ++y) {
      digitalWrite(layer_pins[y], LOW);
      for (z = 0; z < 4; ++z) {
        analogWrite(pwm_pins[z], arr[state[x][y][z]]);
      }
      digitalWrite(layer_pins[y], HIGH);
    }
  }
}
